#!/usr/bin/env bash
# b5 Taskfile, see https://git.team23.de/build/b5 for details
prepare:templates() {
    template:render --overwrite ask-if-older templates/config.local.yml.jinja2 config.local.yml
    template:render --overwrite ask-if-older templates/.env.jinja2 ../web/.env
}

task:install() {
    local laracms="../packages/laravel-cms/"
    local laracms_git="https://github.com/bambamboole/laravel-cms.git"

    if [[ ! -d "${laracms}" ]]; then
        mkdir -p "../packages"
        (cd "../packages/" && git clone "${laracms_git}")
    fi

    task:composer-cms install
    task:composer install
    task:npm-cms install
    task:npm-cms run dev
    task:npm install
    task:npm run dev
    task:link-assets
    prepare:templates
    task:artisan cms:migrate
    task:phpunit-cms
}

task:run() {
    docker:docker-compose up "$@"
}

task:halt() {
    docker:docker-compose down "$@"
}

task:composer() {
    docker:command:composer "$@"
}

task:composer-cms() {
    docker:command:composer-cms "$@"
}

task:artisan() {
    docker:command:artisan "$@"
}

task:npm() {
    docker:command:npm "$@"
}

task:npm-cms() {
    docker:command:npm-cms "$@"
}

task:phpunit() {
    docker:command:phpunit "$@"
}

task:phpunit-cms() {
    docker:command:phpunit-cms "$@"
}

task:shell() {
    container="$1"
    command="$2"
    additionalArguments="${@:3}"
    docker:container_run "${container:-php}" "${command:-/bin/bash}" ${additionalArguments:-}
}

task:link-assets(){
    DIR="../web/public/vendor/cms"
    if [[ ! -d "$DIR" ]]; then
      mkdir -p ${DIR}
    else
      rm -rf ${DIR}
    fi
    if [[ ! -L "$DIR" ]]; then
      (
        cd ../web/public/vendor && ln -s ../../../packages/laravel-cms/dist cms
      )
    fi
}
